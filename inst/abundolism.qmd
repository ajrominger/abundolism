---
title: "Intermediate abundance promotes speciation when dispersal is limited"
author:
  - name: Andrew J. Rominger
  - name: Luke J. Harmon
  - name: Isaac Overcast
  - name: Christine E. Parent
  - name: James L. Rosindell
  - name: Catherine E. Wagner

format:
  pdf:
    keep-tex: true
    include-in-header: 
      text: |
        \usepackage{xr}
        \externaldocument{ab_supp}
        \newcommand{\sfig}[1]{Supplementary Figure~\ref{#1}}
        \newcommand{\ssec}[1]{Supplementary Section~\ref{#1}}

csl: oikos.csl
bibliography: abundolism.bib
---

## Abstract 

Stub




## Introduction


```{r}
#| label: setup
#| include: false

library(knitr)
library(kableExtra)
library(dplyr)
library(ggplot2)
library(ggpointdensity)
library(grid)
library(sf)

opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# helper funciton to load cache from supp
load_supp <- function(cname) {
    f <- sprintf("%s.*RData", cname) |> 
        grep(list.files("ab_supp_cache/pdf", full.names = TRUE), 
              value = TRUE) |> 
        gsub("\\.RData", "", x = _)
    
    o <- lazyLoad(f, envir = globalenv())
}

```

```{r}
#| label: supp
#| include: false
#| cache: true
#| cache.extra: !expr file.info("ab_supp.qmd")$mtime

# render the supplement so can be referenced and used in main

quarto::quarto_render("ab_supp.qmd", quiet = TRUE)

# need .aux file for corss referencing
tinytex::xelatex("ab_supp.tex", clean = FALSE)
```

A fundamental question in evolutionary ecology concerns why some clades are diverse while others are not. Are there properties of species and lineages that promote speciation? One line of inquiry with a long and convoluted history is the role of rarity and commonness is driving diversification. Going back over 150 years, @darwin argued that widespread, abundant species should be superior competitors and thus more likely to give rise to new species. 

This line of thinking carried forward to macroecologists who attempted to model, with some empirical support, the presumed positive association between commonness, fitness, and speciation [@maurer1999]. Paleontologists searched for relationships between commonness and diversification, alternately finding evidence for a positive relationship [@krug2008] but also a negative relationship [stanley1986; @jablonski2003]. Empirical studies of modern taxa have largely found that commonness is negatively or inconclusively related to measures of diversification [@jablonski2003; @makarieva2004; @greenberg2017; @smyvcka2023; @afonso2025; but see @hay2022]. While some of these studies focus specifically on average abundance, others on range size, and some on both, the two macroecological properties are most often strongly correlated [@brown1995; @gaston2002] and for now we will treat both as existing on a continuum between rarity and commonness.

More recent theoretical and modeling work has largely assumed a positive relationship between commonness and diversification. @hubbell2001 perhaps started this trend with the inclusion of "point mutation" speciation in the Unified Neutral Theory of Biodiversity (UNTB). Because point mutation speciation assumes a constant probability of specaition for every individual, lineages with more individuals will experience more speciation events in the UNTB [@hubbell2001; etienne2007modes]. The speciation mechanism first proposed by @hubbell2001 was never an accurate model of real diversification, but even later attempts to increase the realism of speciation in the UNTB retain the emergent property that more abundant lineages will undergo more specaition: protracted speciation [@rosindell2010protracted] again assumes that incipient speciation is constant across individuals and thus full speciation will scale positively with lineage abundance; fission speciation [@etienne2011fission] also assumes the probability of fission (the event that leads to speciation) increases with the number of individuals in a species.  Largely independently from UNTB and its descendants, phylogenetic models of geographic change and diversification also explicitly assume that more widespread species have greater opportunity for speciation [@goldberg2011].

However, another process underlies speciation itself, the study of speciation in relation to commonness, and the relationship between abundance and range size: dispersal.  Dispersal is a key mechanism by which populations can become isolated or connected, potentially leading to specaition or admixture [@yamaguchi2022]; it is a key process in phylogenetic models of geographic change and diversification [@matzke2014]; it is necessary to maintain biodiversity in the UNTB [@hubbell2001]; and it is the mechanism connecting abundance to range size in both neutral [@hubbell2001] and non-neutral [@brown1995] macroecological models. 

Due to the potential for dispersal to create population isolates but also swamp out regional differences that could have led to specaition, it remains an intriguing question what the connection is between dispersal ability as a biological trait and speciation as an evolutionary outcome [@yamaguchi2022]. Some empirical studies have found that measures of diversification have a hump-shaped or negative relationship with morphological proxies for dispersal ability [@price2004; @claramunt2012; @czekanski2019] while others have found a positive to flat relationship between dispersal ability and diversification [@claramunt2025]. Agent-based model simulations have supported the idea of a trade-off between too little dispersal leading to population instability and too much dispersal leading to admixture with intermediate dispersal balancing the two extremes allowing for speciation [@birand2012; @ashby2020; @ciccheto2024]. 

But dispersal is not just a trait connected to morphology or imposed in a simulation, it emerges from population dynamics: each individual carries some probability of dispersing, thus species with more individuals will present with higher dispersal. This is the assumption, a realistic one, in birth-death-immigration models [@kendall1948] of which the UNTB is one [@hubbell2001; alonso2004]. Therefore, commonness and dispersal are interconnected and interdependent in their effects on speciation if they indeed have any consistent effects. It also remains an open debate whether their effects result from the determinism of adaptive evolution as @darwin believed or instead emerge from chance. 

Here we develop a birth-death-immigration model with protracted specaition embedded in a landscape of multiple local populations connected with limited dispersal to investigate the role of abundance and chance in modulating the probability of speciation. Contrary to @darwin and UNTB [@hubbell2001; @etienne2007modes; @rosindell2010protracted; @etienne2011fission], we find that intermediate abundances lead to the greatest probability for dispersal. Critically, this result does not depend in any way on whether populations are more or less adaptively fit, it only depends on a balance between large enough population sizes to accrue sufficient probability of incipient speciation but small enough population sizes to not loose regional differentiation due to increased dispersal. We also analyze real data on the species richness and abundance of endemic arthropods in the pae ʻāina Hawaiʻi finding empirical evidence for intermediate abundance promoting speciation.


## Methods

### Simulating a birth-death-immigration process with speciation

We simulate a birth-death-immigration process (BDI) with speciation (BDIS) in a modified metapopulation [@hanski1998] setting. In this setting there are a number of local populations connected by dispersal as well as an global source pool connected to each local population by dispersal. The global source pool is considered extremely large relative to local populations such that extinction of the global source pool is unlikely on the time scale of local dynamics (we approximate this assumption by never allowing the source pool to go extinct). Local populations grow and shrink according to local births and deaths, dispersal between local populations, and dispersal from the source pool. New species arise via a modified protracted speciation process [@rosindell2010protracted] similar to the model of @tao2021. Our simulation model is consistent with other models derived from the Unified Neutral Theory of Biodiversity [UNTB; @hubbell2001], but unlike those models' multi-species perspectives, we only concern ourselves with a single species and whether that one species undergoes a speciation event. In that way we do not in fact make the assumption of per capita neutrality across species, meaning our results could be generalization to multi-species eco-evolutionary models based on niche theories [@niche-stuff].

Our simulation proceeds according to these rules:

1. Birth, death, immigration, and speciation all happen independently and are determined by their own respective rates 
2. Speciation has 2 steps:
    i. incipient speciation happens by turning one local population into an incipient new species
    ii. if the incipient species lasts long enough it becomes a new species; "long engough" is determined by a waiting time parameter $\tau$---the larger $\tau$, the longer an incipient species must wait before becoming a genuinely new species
3. Immigration between local communities and from the global source pool slows the progress toward speciation;  if an incipient species has to wait $\tau$ time (in the absence of immigration) until it is a full species, each immigration event adds an increment to $\tau$ of $\xi / n_i$ where $\xi$ is a parameter we can set and $n_i$ is the population size of the incipient species
4. Once full speciation occurs the simulation is stopped; if the simulation reaches the maximum designated number of iterations without full speciation, then the simulation stops anyway

```{r}
#| label: fig-concpt
#| fig-width: 7
#| fig-height: 5
#| fig-cap: |
#|     Conceptual overview of our simulation model. 
#| cache: true

# function to draw ellipse
draw_ellipse <- function(x, y, rx, ry, n = 100, gp = gpar()) {
    theta <- seq(0, 2 * pi, length.out = n)
    ex <- x + rx * cos(theta)
    ey <- y + ry * sin(theta)
    grid.polygon(ex, ey, gp = gp)
}

# function to draw a cloud shape
draw_cloud <- function(x, y, r, gp = gpar()) {
    # sf uniion of circles
    cloud <- lapply(1:length(x), function(i) {
        st_buffer(st_point(c(x[i], y[i])), r[i])
    }) |>
        st_sfc() |>
        st_union()

    coords <- st_coordinates(cloud)[, 1:2]

    grid.polygon(coords[, 1], coords[, 2], gp = gp)
}



# colors, sizes, pars
src_blu <- "#3D9BBA"
pop_blu <- "#1D4C7F"
blk <- "#412925"
gry <- "#C4B6B3"
txt_gld <- "#FDB318"

lw <- 2
fsize <- 16

arrow_gp <- gpar(col = gry, lwd = 6)
txt_gp <- gpar(col = txt_gld, fontsize = fsize)
pop_gp <- gpar(col = txt_gld, fontsize = fsize * 1.4)
box_gp <- gpar(fill = blk, col = gry, lwd = lw)

# start
grid.newpage()

# clobal source pool
draw_cloud(x = c(-0.08, 0.1, 0.25, 0.35, 0.1) + 0.025,
           y = c(0.85, 0.9, 0.95, 1, 1),
           r = c(0.175, 0.1, 0.08, 0.1, 0.15),
           gp = gpar(fill = src_blu, col = blk, lwd = lw))
grid.text("global source pool",
          x = 0.01, y = 0.95, just = "left",
          gp = pop_gp)
x <- grid.text(expression(italic("size:")~italic(infinity)),
          x = 0.01, y = 0.87, just = "left",
          gp = pop_gp)

# local pops
rx <- 0.2
ry <- 0.15
ly <- 0.42

# local pop j
draw_ellipse(x = 0.25, y = ly, rx = rx, ry = ry,
             gp = gpar(fill = pop_blu, col = blk, lwd = lw))
grid.text(expression("local population"~italic(j)),
          x = 0.25 - rx + 0.025, y = ly + 0.025, just = "left",
          gp = pop_gp)
grid.text(expression(italic("size:")~italic(x[j])),
          x = 0.25 - rx + 0.025, y = ly - 0.045, just = "left",
          gp = pop_gp)

# local pop i
draw_ellipse(x = 0.75, y = ly, rx = rx, ry = ry,
             gp = gpar(fill = pop_blu, col = blk, lwd = lw))
grid.text(expression("local population"~italic(i)),
          x = 0.75 - rx + 0.05, y = ly + 0.025, just = "left",
          gp = pop_gp)
grid.text(expression(italic("size:")~italic(x[i])),
          x = 0.75 - rx + 0.05, y = ly - 0.045, just = "left",
          gp = pop_gp)

# dispersal j to i
grid.curve(x1 = 0.42, y1 = ly - 0.09, x2 = 0.58, y2 = ly - 0.09,
           curvature = 0.7, square = FALSE,
           arrow = arrow(length = unit(0.3, "cm")),
           gp = arrow_gp)
grid.roundrect(x = 0.5, y = ly - 0.19, width = 0.28, height = 0.07,
               r = unit(0.25, "npc"),
               gp = box_gp)
grid.text(expression(italic("rate:")~italic(m[prop]*gamma*x[j](k))),
          x = 0.5, y = ly - 0.19,
          gp = txt_gp)

# dispersal i to j
grid.curve(x1 = 0.75, y1 = ly - 0.16, x2 = 0.25, y2 = ly - 0.16,
           curvature = -0.6, square = FALSE,
           arrow = arrow(length = unit(0.3, "cm")),
           gp = arrow_gp)
grid.roundrect(x = 0.74, y = ly - 0.32, width = 0.28, height = 0.07,
               r = unit(0.25, "npc"),
               gp = box_gp)
grid.text(expression(italic("rate:")~italic(m[prop]*gamma*x[i](k))),
          x = 0.74, y = ly - 0.32,
          gp = txt_gp)

# local dispersal tag
grid.roundrect(x = 0.18, y = ly - 0.32, width = 0.35, height = 0.07,
               r = unit(0.25, "npc"),
               gp = box_gp)
grid.text("multiple local dispersal", 
          x = 0.18, y = ly - 0.32,
          gp = txt_gp)


# global dispersal

lf <- ly + 0.37

# to j
grid.curve(x1 = 0.5, y1 = lf, x2 = 0.35, y2 = ly + 0.14,
           curvature = -0.2, square = FALSE,
           arrow = arrow(length = unit(0.3, "cm")),
           gp = arrow_gp)

# to i
grid.curve(x1 = 0.5, y1 = lf, x2 = 0.65, y2 = ly + 0.14,
           curvature = -0.2, square = FALSE,
           arrow = arrow(length = unit(0.3, "cm")),
           gp = arrow_gp)

# to fork
grid.curve(x1 = 0.45, y1 = 0.925, x2 = 0.5, y2 = lf,
           curvature = -0.2, square = FALSE,
           gp = arrow_gp)


# global dispersal tag
grid.roundrect(x = 0.61, y = lf + 0.13, width = 0.26, height = 0.11,
               r = unit(0.25, "npc"),
               gp = box_gp)
grid.text("global dispersal",
          x = 0.5, y = lf + 0.15, just = "left",
          gp = txt_gp)
grid.text(expression(italic("rate:"~italic(gamma))),
          x = 0.5, y = lf + 0.1, just = "left",
          gp = txt_gp)


# equal prob tag
grid.roundrect(x = 0.63, y = lf - 0.1, width = 0.69, height = 0.08,
               r = unit(0.25, "npc"),
               gp = box_gp)
grid.text("recipient population chosen w/ equal probability",
          x = 0.63, y = lf - 0.1,
          gp = txt_gp)

```

Full details of the simulation are provided in \ssec{sec-sim}. Underlying C++ and R source code is available in the R package *abondolism* [@abundolism-package] accompanying this paper.

### Simulation experiment

```{r}
#| label: pars-info-setup


# loads `par_range`, `np`, `nstep`, `nrep`
load_supp("par-range")
```

@tbl-pars summarizes the simulation parameters in our model and the range of values we use in our simulation experiment. In all cases parameter values are drawn from a uniform distribution. A total of `r format(nrep, big.mark = ",", scientific = FALSE)` simulations were run, each with a unique set of randomly sampled parameters.


```{r}
#| label: tbl-pars
#| tbl-cap: |
#|     Parameters govering the simulation and their ranges over the simulation experiment. Mathematical parameter names are given first followed by their name in the simulation code. Note `np` and `nstep` were fixed throughout the course of the simulation experiment


par_info <- data.frame(param = c("np", "nstep"), 
                       min = c(np, nstep), 
                       max = c(np, nstep)) |> 
    (\(x) rbind(par_range, x))() 

par_desc <- c(
    "local birth rate", 
    "local death rate", 
    "dispersal rate from the global source pool to one local population", 
    "proportional dispersal rate between local populations relative to global rate", 
    "incipient speciation rate", 
    "wait time to full speciation in the absence of dispersal", 
    "amount each dispersal event sets back the progression toward speciation", 
    "number of local populations", 
    "number of simulation iterations"
) |> 
    setNames(par_info$param)


par_tab <- select(par_info, param) |> 
    mutate(
        par_name = case_match(param, 
                              "la" ~ "$\\lambda$", 
                              "mu" ~ "$\\mu$", 
                              "g" ~ "$\\gamma$", 
                              "m_prop" ~ "$m_\\text{prop}$", 
                              "nu" ~ "$\\nu$", 
                              "tau" ~ "$\\tau$", 
                              "xi" ~ "$\\xi$", 
                              "np" ~ "$n_p$", 
                              "nstep" ~ "$n_\\text{step}$"), 
        par_code = sprintf("(\\texttt{%s})", param) |> 
            gsub("_", "\\\\_", x = _),
        description = par_desc[param]
    ) |> 
    left_join(par_info) |> 
    select(-param) |> 
    relocate(description, .after = max)
    

kable(par_tab, booktabs = TRUE, format = "latex",
      col.names = NULL, align = "rrrrl", escape = FALSE, 
      format.args = list(big.mark = ",", scientific = FALSE)) |>
    add_header_above(c("parameter" = 2, "range" = 2, "description" = 1), 
                     line = TRUE) |> 
    column_spec(5, width = "3in")

```

Parameter values were chosen as a balance between biological realism and computational efficiency: rates are sufficiently fast to allow for abundances to reach levels often found in survey data (e.g. the arthropod survey data we analyze here) within 


```{r}
load_supp("run-sim")


```



### Analysis of arthropod richness and abundance from the pae ʻāina Hawaiʻi

Gruner abundance: calculate mean across sites

Bishop checklist: *generally* each native genus got here once and radiated

## Results 

```{r}
#| label: fig-sim
#| fig-width: 4
#| fig-height: 3
#| fig-cap: |
#|     Relationship across simulation runs between average abundance 
#|     over local populations and speciation. Curve is a quadratic binomial
#|     generalize linear model and gray region shows 95% confidence envelope 

# loads `sim_fig`
load_supp("make-sim-fig")

sim_fig
```

So we see there is a sweet spot of intermediate abundance where speciation is most likely to take place!

## To-do

- intro
- bring in HI arth data
- figure out if want to model arth data with stan
- if yes, connect prob(speciation) to rate (r = delta_t p o(delta_t)) and connect that to neg binom regression


## References 
