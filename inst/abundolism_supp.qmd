---
title: "Supplement to: *Speciation peaks at intermediate abundance*"
format:
  pdf:
    include-in-header: 
      text: |
        \renewcommand{\figurename}{Supplementary Figure}
        \renewcommand*{\thesection}{S\arabic{section}}
    keep-tex: false
csl: oikos.csl
bibliography: abundolism.bib
---


## Introduction

```{r}
#| label: setup
#| include: false

# quarto::quarto_render()
```

- @jablonski2003: "Late Cretaceous gastropod genera exhibit a strong negative relation between the geographical ranges of constituent species and speciation rate per species per million years...These results support the view that the factors promoting broad geographical ranges also tend to damp speciation rates" analysis of modern only might not reveal this pattern---why Hawawi\'i could be a good place to look
- @krug2008: uses spp:gen ratio. widespread bival genera have more species. "Species within these cosmopolitan genera may have life-history traits or other attributes that allow for rapid adaptation to new environments, promoting both speciation and range expansion of a lineage"
- @birand2012: ABM, but about range and pixles are agents. found increased dispersal decreases speciation
- @hay2022: Provides good background on range size +/- corr with speciation. "Honeyeater speciation rate differs considerably between islands and the continental setting across the clade’s distribution, with range size contributing positively in the continental setting, while dispersal ability influences speciation regardless of setting. These outcomes support Darwin’s original proposal for a positive relationship between range size and speciation likelihood, while extending the evidence for the contribution of dispersal ability to speciation."
- @goldberg2011: GeoSSE model assumes speciation increases with range size, extinction decreases with it
- @smyvcka2023: hard to say if range size is + or - corr with speciation (could be impacted by change in range size with speciation)
- @kisel2010: gene flow important for speciation; islands good for studying speciation
- @gaston2002: classic reference on range size + corr with speciation 
- @pigot2010: model of range size and diversification: finds larger ranges produce more speciation, but with specaition, ranges shrink, causing specaition slow down
- @ashby2020: ABM showing itermediate dispersal produces most speciation
- @price2004: speciation in Hawai\`i plants; intermediate disperal hypothesis; should check for possible data usability on lineage designation 
- @claramunt2012: "Using a surrogate for flight performance and a species-level DNA-based phylogeny of a large South American bird radiation (the Furnariidae), we found that lineages with higher dispersal ability experienced lower speciation rates."
- @ciccheto2024: model shows intermediate dispersal is optimum for diversification
- @casey2021: extinction up with decreasing abundance (range size also, but less predictive)
- @claramunt2025: "we found mixed evidence for the effect of dispersal on diversification rates: dispersive lineages show either slightly higher speciation rates or higher extinction rates.  Our results therefore suggest that high dispersal ability increases range expansion and turnover, perhaps because dispersive lineages expand into islands or other geographically restricted environments and have lower population sizes...even though per capita dispersal rates may be high for highly dispersive species, levels of gene flow may be relatively low due to lower population size. This effect may explain why population genetic studies have not consistently found the expected negative relationship between dispersal ability and genetic differentiation71,72,73 and why rates of speciation remain relatively stable across a wide range of dispersal capabilities" 
- @makarieva2004: relationship between abundance and speciation open question. they go into neutral pop gen which we should too
- @afonso2025: negative relationship between gen div and diversification. go into how low gen div, and thus Ne, could drive speciation
- @rosindell2010protracted: protracted speciation; still most abundant is speciator 
- @etienne2011fission: fission speciation; still most abundant is speciator 
- @etienne2007modes: makes explicit "the speciation rate of a species is directly proportional to its abundance in the metacommunity." Find abundance-independent speciation is poor fit to data, indicates speciation matters
- @stanley1990: speciation and extinction are correlated; could be abundance driven, dispersal driven, specialization driven
- @stanley1986: speciation, extinction correlated in Neogene bivalvs he was looking at; proposed a model for humped speciation across abundance
- @darwin: widespread, more common leads to more speciation because of superiority
- @maurer1999: organizes darwin's argument about widespread species being greater speciators
- @brown1995: abundance range size correlation
- @czekanski2019: review finding that poor dispersal is key in producing "nonadatpive" radiations
- @greenberg2017: link between extant species diversity and extinction risk (arguing for correlation between etinciton and speciation)














## Birth-death-immigration model with speciation

We simulate a birth-death-immigration model (BDI) with speciation (BDIS) in a metapopulation setting. This is the set-up

- There are `np` number of local populations in the metapopulation
- There is a global source pool

Here are the biological process steps:

1. Birth, death, immigration, and speciation all happen indipendently and are determined by respective rates (see params below)
2. Speciation has 2 steps:
    i. incipient speciation happens by turning one local population into an incipient new species
    ii. if the incipient species lasts long enough it becomes a new species
3. Immigration between local communities and from the global source pool slows the progress toward speciation (technically if an incipient species has to wait $\tau$ time (in the absence of immigration) until it's a full species, each immigration event adds an increment to $\tau$ of $\xi / n_i$ where $\xi$ is a parameter we can set and $n_i$ is the population size of the incipient species)
4. Once full speciation occurs the simulation is stopped; if the simulation reaches the maximum designated number of iterations (`nstep`) without full speciation, then the simulation stops anyway

Here are the parameters:

- $\lambda$ (`la`): birth rate
- $\mu$ (`mu`): death rate
- $\gamma$ (`g`): immigration rate from global source pool
- $m_p$ (`m_prop`): proportional immigration rate between local populations; immigration rate $m = \gamma \times m_p$ 
- $\nu$ (`nu`): incipient speciation rate
- $\tau$ (`tau`): wait time to full speciation in the absence of immigration
- $\xi$ (`xi`): amount each immigrant sets back the progression toward speciation
- (`np`): number of local populations
- (`nstep`): number of iterations to run simulation for

And we can now actually run this thing and see what happens

```{r}
#| eval: false


library(abundolism)

nrep <- 1000 # number of different parameter combos to look at
la <- runif(nrep, 1, 10)
mu <- runif(nrep, 1, 10)
g <- la * runif(nrep, 0, 0.1)
m_prop <- runif(nrep, 0, 0.1)
nu <- runif(nrep, 0, 0.001)
tau <- runif(nrep, 0, 4) #10 / (la + mu + runif(nrep, 0, 1))
xi <- rep(1, nrep)
np <- 4
nstep <- 100000


# `sim_BDI_spec` is the workhorse function
sim_dat <- sim_BDI_spec(la = la, mu = mu, g = g, m_prop = m_prop,
                        nu = nu, tau = tau, xi = xi, np = np,
                        nstep = nstep)

ggplot(sim_dat, 
       aes(x = tau, speciation)) +
    geom_pointdensity(method = "kde2d") +
    scale_shape_binned() +
    scale_color_viridis_c() +
    # scale_x_log10() +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial"), 
                color = "black")

ggplot(sim_dat, aes(time, mean_pop_size)) +
    geom_point(data = select(sim_dat, !speciation), 
               mapping = aes(time, mean_pop_size), color = "gray50") +
    geom_pointdensity() + 
    facet_wrap(vars(speciation)) +
    scale_x_log10() +
    scale_y_log10() + 
    scale_color_viridis_c(trans = "log10")

ggplot(sim_dat, aes(mean_pop_size)) +
    geom_histogram() +
    scale_x_log10()

```

Now we can plot the results and find out how abundance relates to speciation in this model

```{r}
#| eval: false
#| fig-width: 4
#| fig-height: 3

library(ggplot2)
library(ggpointdensity)

# make a quadratic logistic model
sim_dat$log_pop <- log(sim_dat$mean_pop_size, 10)
mod <- glm(speciation ~ log_pop + I(log_pop^2), data = sim_dat, 
           family = "binomial")

# add to data
sim_dat$mod_pred <- predict(mod, type = "response")

ggplot(sim_dat, 
       aes(x = mean_pop_size, y = speciation)) +
    geom_pointdensity() +
    scale_color_viridis_c() +
    scale_x_log10() +
    scale_y_continuous(breaks = c(0, 1)) + 
    xlab("Mean population size") +
    ylab("Speciation probability") +
    theme(panel.grid.minor.y = element_blank()) +
    geom_smooth(method = glm, formula = y ~ x + I(x^2), 
                method.args = list(family = "binomial"), color = "black")



ggplot(sim_dat, aes(x = mean_pop_size)) +
    geom_histogram() +
    scale_x_continuous(transform = "log10")

```

```{r}
#| label: fig-one
#| fig-cap: |
#|     A test figure

plot(1)
```


So we see there is a sweet spot of intermediate abundance where speciation is most likely to take place!

## To-do

- intro
- bring in HI arth data
- figure out if want to model arth data with stan
- if yes, connect prob(speciation) to rate (r = delta_t p o(delta_t)) and connect that to neg binom regression
